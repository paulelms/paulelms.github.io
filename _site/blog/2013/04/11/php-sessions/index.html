<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title> PHP: пишем свою реализацию сессий для обработки мертвой сессии перед зачисткой |  Unix Way</title>
        <link rel="stylesheet" href="/style.css" />
        <meta name="description" content="Пишу про Mac OS X, Android, iOS, Emacs, Веб-разработку, свободное ПО и т.д."/>
        <meta name="author" content="Paul Elms"/>
        <link rel="author" href="humans.txt"/>
        <link rel="alternate" type="application/rss+xml" title="Atom Feed" href="http://feeds.feedburner.com/vyazovoi" />
    </head>

    <body>
        <header>
            <hgroup>
            <h1><a href="/">Unix Way</a></h1>
                <h4>Пишу про Mac OS X, Android, iOS, Emacs, Веб-разработку, свободное ПО и т.д.</h4>
            </hgroup>
			<nav>
	<ul>
		<li><a href="/">Об авторе</a></li>
		<li><a href="/blog">Блог</a></li>
		<li><a href="/blog/archives">Архив</a></li>
	</ul>
</nav>

<div style="float: right;">
	<a href="https://twitter.com/vyazovoi" class="twitter-follow-button" data-show-count="false" data-lang="ru">Читать @vyazovoi</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>
            <hr />
        </header>
		
		<div style="position: absolute; right: 0; top: 0;"><img style="width: 150px;" src="/images/under_construction.gif"></div>

        <main>

            <article>
        <header>
            <h2>PHP: пишем свою реализацию сессий для обработки мертвой сессии перед зачисткой</h2>
            <span><time datetime="2013-04-11">Apr 11, 2013</time></span>, <span class="author"> Paul Elms</span>, Категории: <span class="category"> Веб-разработка PHP </span>
        </header>

        <div class="entry">      <div style="text-align: center;"><h2>Репост моей оооочень старой статьи на хабре исключительно на память</h2></div>

      <p>Представим ситуацию: есть корзина покупок на сайте, при добавлении в корзину мы ставим на товар т.н. lock, исключающий его из списка доступных для покупки товаров. Когда клиент удаляет товар из корзины - lock снимается. Но что делать, если пользователь просто закрыл браузер? В таком случае сессия будет удалена сборщиком мусора, а локи так и останутся.
      </p>

      <p>Когда я столкнулся с такой ситуацией, первое что мне пришло в голову - хранить
      локи и дату доступа в БД и периодически дергать её кроном. Но костыльность этого
      решения очевидна. Я вообще недолюбливаю web-программирование на PHP за
      часто-встречающуюся костыльность многих решений. А ещё за бред, с которым я
      столкнулся при решении сабжа: для сериализации и десереализации сессий используются
      функции и формат, отличные от функций serialize и unserialize. Приходится делать
      велосипеды для ансериализации сессии.</p>

      <!--more-->
      
      <p>Ближе к телу: как решил проблему я...<br />
        Тут надо сделать замечание, что идею для такого решения мне подал хабраюзер rigid,
        а помогли решить пару около-сабжевых проблем в конференции
        php@conference.jabber.ru.</p>

      <p>PHP позволяет определять свои функции для обработки сессий. Отвечает за это
      функция session_set_save_handler. В качестве параметров она принимает список
      функций, который будут вызываться для работы с сессиями. В мануале есть даже пример,
      который реализует стандартный механизм работы с сессиями. Его-то мы и возьмем,
      изменив только функцию gc, которая занимается сборкой мусора, т.е. удалением файлов
      мертвых сессий.</p>

      <p>Пример функции gc:</p>

      <p>
		<div>
  <pre><code class='php'>/* Функция принимает в качестве параметра время жизни сессии */
function gc($maxlifetime)
  {
        global $sess_save_path; /* путь, где лежат сессии */
        foreach (glob(&quot;$sess_save_path/sess_*&quot;) as $filename)
      {
                /* Проверяем не пора ли убить сессию */
                if (filemtime($filename) + $maxlifetime &lt; time())
                  {
                        /* $tmp_sess у нас теперь аналогична $_SESSION той сессии */
                        $tmp_sess=unserializesession(file_get_contents($filename));
                        /* Обрабатываем данные, например снимаем локи из этой сессии */
                        @unlink($filename); /* Удаляем сессию */
                  }
          }
        return true;
  }</code></pre>
</div>

</p>

      <p>Код функции unserializesession, взятый откуда-то из интернета (скорее всего из
      комментариев к функции в мануале PHP):</p>

      <p>
<div>
  <pre><code class='php'>function unserializesession($data) {
  $vars=preg_split(&#39;/([a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff^|]*)\|/&#39;,
                   $data,-1,PREG_SPLIT_NO_EMPTY | PREG_SPLIT_DELIM_CAPTURE);
  for($i=0; $vars[$i]; $i++) $result[$vars[$i++]]=unserialize($vars[$i]);
  return $result;
}</code></pre>
</div>

	</p>      
 
      <p>Теперь подключаем это в наш проект:</p>

      <p>
<div>
  <pre><code class='php'>session_set_save_handler(&quot;open&quot;, &quot;close&quot;, &quot;read&quot;, &quot;write&quot;, &quot;destroy&quot;, &quot;gc&quot;);
/* Вероятность чистки мусора на каждый session_start() примерно равна 30%,
другими словами - чистка мертвых сессий будет производится при тридцати вызовах session_start() из ста */
ini_set(&quot;session.gc_probability&quot;, 30); /* Можно настроить на 100%, если у вас там нет никакого медленного кода */
ini_set(&quot;session.gc_divisor&quot;, 100);
ini_set(&quot;session.gc_maxlifetime&quot;, 1800); /* Время жизни сессии в секундах (то самое, которое передается в функцию gc) */
session_start();</code></pre>
</div>

      </p>

      <p>Есть одно но: в Debian/Ubuntu свой механизм очистки сессий, который выполняется кроном, а у PHP нет возможности удалять файлы сессий. Честно говоря, это "черезжопа". Решить проблему можно задав собственный каталог для файлов сессии и закрыв его в .htaccess (если он находится в document_root).</p></div>
		
		<div class="comments">    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'paulelms'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>

        <footer><!-- additional info --></footer>

</article>

        </main>

        <footer>
            <hr />
            <p>&copy; <time>2013</time> Paul Elms</p>
        </footer>
		
		<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-26844854-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

    </body>

</html>